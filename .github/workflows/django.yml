name: Django CI/CD to PythonAnywhere (SSH)

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PA_USER: ${{ secrets.PA_USERNAME }}  # 从 Secrets 获取用户名

    steps:
      - name: Execute Deployment
        run: |
          ssh-keyscan -H ssh.pythonanywhere.com >> ~/.ssh/known_hosts
          ssh -t -o StrictHostKeyChecking=no ${PA_USER}@ssh.pythonanywhere.com << 'DEPLOY'
          # 显式设置变量
          export PROJECT_DIR="${{ secrets.PA_PROJECT_DIR }}"
          export VENV_NAME="${{ secrets.PA_VENV_NAME }}"
          
          # 调试：打印变量值
          echo "PROJECT_DIR: $PROJECT_DIR"
          echo "VENV_NAME: $VENV_NAME"
          
          # 进入项目目录
          cd $PROJECT_DIR || { echo "Directory $PROJECT_DIR not found"; exit 1; }
          
          # 拉取代码
          git reset --hard HEAD
          git clean -fd
          git pull origin main
          
          # 激活虚拟环境
          source ~/.virtualenvs/$VENV_NAME/bin/activate || { echo "Virtualenv $VENV_NAME not found"; exit 1; }
          
          # 安装依赖
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Django 操作
          python manage.py migrate
          python manage.py collectstatic --noinput
          
          # 重启应用
          reload_webapp || touch ~/reload.trigger
          DEPLOY
